@using Sandbox
@using Sandbox.UI
@using Ultraneon.Player
@inherits PanelComponent
@attribute [StyleSheet]
@namespace Ultraneon.UI

<root>
	<VitalsPanel Player="@Player"/>
	<InventoryPanel Inventory="@Inventory"/>
	@if ( Inventory?.ActiveWeapon != null )
	{
		<AmmoPanel Weapon="@Inventory.ActiveWeapon"/>
	}
	<CrosshairPanel/>
	<RadarPanel/>
	<InfoFeedPanel Messages="@InfoMessages"/>
</root>

@code
{
	[Property]
	public PlayerNeon Player { get; set; }

	[Property]
	public PlayerInventory Inventory { get; set; }

	private List<InfoFeedPanel.InfoMessage> InfoMessages { get; set; } = new List<InfoFeedPanel.InfoMessage>();

	protected override void OnEnabled()
	{
		base.OnEnabled();
		Player = Scene.GetAllComponents<PlayerNeon>().FirstOrDefault( x => x.GameObject.Tags.Has( "player" ) );
		Inventory = Player?.GameObject.Components.Get<PlayerInventory>();
	}

	protected override int BuildHash()
	{
		if ( !Player.IsValid() ) return 0;

		var hash = System.HashCode.Combine(
			Player?.Health,
			Inventory?.SelectedSlot,
			Inventory?.ActiveWeapon?.WeaponType,
			Inventory?.ActiveWeapon?.CurrentAmmo,
			Inventory?.ActiveWeapon?.ClipSize,
			InfoMessages.Count
		);

		return hash;
	}

	public void Show()
	{
		Panel.SetClass( "hidden", false );
		Player ??= Scene.GetAllComponents<PlayerNeon>().FirstOrDefault(x => x.GameObject.Tags.Has("player"));
		Inventory ??= Player?.GameObject.Components.Get<PlayerInventory>();
	}

	public void Hide()
	{
		Panel.SetClass( "hidden", true );
	}

	public void AddInfoMessage( string message, InfoFeedPanel.InfoType type )
	{
		Log.Info( $"[Hud] [{{type}}] {message} " );
		InfoMessages.Add( new InfoFeedPanel.InfoMessage( message, type ) );
		if ( InfoMessages.Count > InfoFeedPanel.MaxMessages )
		{
			InfoMessages.RemoveAt( 0 );
		}

		StateHasChanged();
	}
}
